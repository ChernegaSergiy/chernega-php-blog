{% extends 'base.html.twig' %}

{% set page_title = 'Візуалізатор Mermaid.js' %}

{% block meta %}
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
{% endblock %}

{% block content %}
    <div class="sol-terminal sol-mb-lg">
        <span class="sol-prompt">run mermaid_visualizer</span>
    </div>

    <div class="sol-grid sol-mb-lg">
        <div class="sol-col-lg-7 sol-col-md-8">
            <div class="sol-card">
                <div class="sol-card__header">Синтаксис Mermaid.js</div>
                <div class="sol-card__body">
                    <p>Введіть або вставте свій код Mermaid:</p>
                    <textarea id="mermaidInput" class="sol-textarea" rows="12" placeholder="Введіть Mermaid синтаксис...">flowchart TD
A([Початок]) --> B[Процес]
B --> C{Рішення?}
C -->|Так| D[Дія 1]
C -->|Ні| E[Дія 2]
D --> F([Кінець])
E --> F([Кінець])</textarea>
                </div>
                <div class="sol-card__footer sol-flex sol-flex--between sol-flex--wrap">
                    <button id="renderButton" class="sol-btn sol-btn--primary sol-mb-sm">Згенерувати діаграму</button>
                    <button id="clearButton" class="sol-btn sol-btn--secondary sol-btn--outline sol-mb-sm">Очистити</button>
                </div>
            </div>
        </div>
        <div class="sol-col-lg-5 sol-col-md-4">
            <div class="sol-card sol-h-100">
                <div class="sol-card__header">Результат візуалізації</div>
                <div class="sol-card__body">
                    <div id="mermaidOutput" class="sol-mermaid-output" style="min-height: 300px; overflow: auto;">
                        Готова діаграма з'явиться тут після генерації.
                    </div>
                </div>
                <div class="sol-card__footer">
                    <button id="downloadButton" class="sol-btn sol-btn--success sol-w-full" disabled>Завантажити SVG</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sol-card sol-mb-lg">
        <div class="sol-card__header">Приклади діаграм</div>
        <div class="sol-card__body">
            <div class="sol-grid">
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="flowchart">
                        <h5 class="sol-mb-sm">Блок-схема</h5>
                        <pre class="sol-code">flowchart TD
A --> B --> C</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="sequence">
                        <h5 class="sol-mb-sm">Діаграма послідовності</h5>
                        <pre class="sol-code">sequenceDiagram
A->>B: Повідомлення</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="gantt">
                        <h5 class="sol-mb-sm">Діаграма Ганта</h5>
                        <pre class="sol-code">gantt
title Проєкт
Задача: 2024-01-01, 30d</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="pie">
                        <h5 class="sol-mb-sm">Кругова діаграма</h5>
                        <pre class="sol-code">pie title Статистика
"A": 40
"B": 30
"C": 30</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="class">
                        <h5 class="sol-mb-sm">Діаграма класів</h5>
                        <pre class="sol-code">classDiagram
Animal <|-- Dog</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="state">
                        <h5 class="sol-mb-sm">Діаграма станів</h5>
                        <pre class="sol-code">stateDiagram-v2
[*] --> Off
Off --> On</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="er">
                        <h5 class="sol-mb-sm">ER-діаграма</h5>
                        <pre class="sol-code">erDiagram
CUSTOMER ||--o{ ORDER</pre>
                    </article>
                </div>
                <div class="sol-col-lg-4 sol-col-md-6 sol-mb-md">
                    <article class="sol-surface sol-surface--interactive" data-example="git">
                        <h5 class="sol-mb-sm">Git-діаграма</h5>
                        <pre class="sol-code">gitGraph
commit
branch develop</pre>
                    </article>
                </div>
            </div>
        </div>
    </div>

    <div class="sol-card">
        <div class="sol-card__header">Підтримувані типи діаграм</div>
        <div class="sol-card__body">
            <ul class="sol-list">
                <li><strong>Flowchart</strong> — блок-схеми та діаграми потоку</li>
                <li><strong>Sequence Diagram</strong> — діаграми взаємодії</li>
                <li><strong>Class Diagram</strong> — UML-діаграми класів</li>
                <li><strong>State Diagram</strong> — діаграми станів</li>
                <li><strong>ER Diagram</strong> — сутність-зв'язок</li>
                <li><strong>Gantt Chart</strong> — планування проєктів</li>
                <li><strong>Pie Chart</strong> — кругові діаграми</li>
                <li><strong>Git Graph</strong> — історія гілок Git</li>
            </ul>
            <p class="sol-mt-md">Документація: <a href="https://mermaid.js.org/" target="_blank" rel="noopener">mermaid.js.org</a></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.mermaid) {
                window.mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose',
                });
            }

            const renderButton = document.getElementById('renderButton');
            const clearButton = document.getElementById('clearButton');
            const downloadButton = document.getElementById('downloadButton');
            const input = document.getElementById('mermaidInput');
            const output = document.getElementById('mermaidOutput');
            const exampleCards = document.querySelectorAll('[data-example]');
            let currentSvg = '';

            const exampleSyntax = {
                flowchart: `flowchart TD
A([Початок]) --> B[Процес 1]
B --> C{Умова?}
C -->|Так| D[Процес 2]
C -->|Ні| E[Процес 3]
D --> F([Кінець])
E --> F`,
                sequence: `sequenceDiagram
participant A as Користувач
participant B as Сервер
A->>B: Запит
B-->>A: Відповідь
A->>B: Підтвердження
B-->>A: Готово`,
                gantt: `gantt
title Розклад проєкту
dateFormat  YYYY-MM-DD
section Фаза 1
Планування    :a1, 2024-01-01, 30d
Аналіз        :after a1, 20d
section Фаза 2
Розробка      :2024-02-15, 45d
Тестування    :30d`,
                pie: `pie title Розподіл завдань
"Розробка" : 40
"Тестування" : 25
"Документація" : 20
"Інше" : 15`,
                class: `classDiagram
class Animal {
    +String name
    +int age
    +void eat()
}
Animal <|-- Dog
Animal <|-- Cat
class Dog {
    +void bark()
}
class Cat {
    +void meow()
}`,
                state: `stateDiagram-v2
[*] --> Off
Off --> On : toggle
On --> Off : toggle`,
                er: `erDiagram
CUSTOMER ||--o{ ORDER : places
ORDER ||--|{ LINE-ITEM : contains
PRODUCT ||--|{ LINE-ITEM : ordered_in`,
                git: `gitGraph
commit
commit
branch develop
checkout develop
commit
checkout main
merge develop`,
            };

            async function renderDiagram(diagramCode) {
                const syntax = diagramCode ?? input.value.trim();

                if (!syntax) {
                    output.innerHTML = '<div class="sol-alert sol-alert--warning">Будь ласка, введіть синтаксис Mermaid для генерації.</div>';
                    currentSvg = '';
                    downloadButton.disabled = true;
                    return;
                }

                if (!window.mermaid) {
                    output.innerHTML = '<div class="sol-alert sol-alert--error">Mermaid.js не завантажився.</div>';
                    return;
                }

                const uniqueId = 'mermaid-' + Date.now();

                try {
                    const { svg } = await window.mermaid.render(uniqueId, syntax);
                    output.innerHTML = svg;
                    currentSvg = svg;
                    downloadButton.disabled = false;
                } catch (error) {
                    output.innerHTML = '<div class="sol-alert sol-alert--error">Помилка рендерингу: ' + (error && error.message ? error.message : String(error)) + '</div>';
                    currentSvg = '';
                    downloadButton.disabled = true;
                }
            }

            function clearDiagram() {
                input.value = '';
                output.innerHTML = 'Готова діаграма з\'явиться тут після генерації.';
                currentSvg = '';
                downloadButton.disabled = true;
            }

            function downloadSvg() {
                if (!currentSvg) {
                    alert('Спочатку згенеруйте діаграму.');
                    return;
                }

                const now = new Date();
                const filename = 'mermaid-diagram-' + now.toISOString().replace(/[:.]/g, '-') + '.svg';
                const blob = new Blob([currentSvg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            renderButton.addEventListener('click', () => renderDiagram());
            clearButton.addEventListener('click', clearDiagram);
            downloadButton.addEventListener('click', downloadSvg);

            exampleCards.forEach(card => {
                card.addEventListener('click', () => {
                    const type = card.getAttribute('data-example');
                    if (type && exampleSyntax[type]) {
                        input.value = exampleSyntax[type];
                        renderDiagram(exampleSyntax[type]);
                    }
                });
            });

            // Initial render
            renderDiagram(input.value.trim());
        });
    </script>
{% endblock %}

{% extends 'admin/base.html.twig' %}

{% set admin_nav_active = 'dashboard' %}
{% set current_role = current_admin.role|default('viewer') %}
{% set can_edit_content = current_role in ['editor', 'admin'] %}
{% set is_super_admin = current_role == 'admin' %}

{% block content %}
    <div class="sol-terminal sol-mb-lg">
        <span class="sol-prompt">admin posts list</span>
    </div>

    {% if flashes %}
        {% for flash in flashes %}
            <div class="sol-alert sol-alert--{{ flash.type }} sol-mb-md">{{ flash.message }}</div>
        {% endfor %}
    {% endif %}

    <div class="sol-card">
        <div class="sol-card__header sol-flex sol-flex--between sol-flex--center">
            <span>Posts</span>
            {% if can_edit_content %}
                <a href="/admin/posts/create.php" class="sol-btn sol-btn--primary">Create post</a>
            {% endif %}
        </div>
        <div class="sol-card__body">
            {% if posts is empty %}
                <p class="text-muted">No posts yet.</p>
            {% else %}
                <div class="sol-table-responsive">
                    <table class="sol-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Created</th>
                            <th>Updated</th>
                            {% if can_edit_content %}<th class="sol-text-right">Actions</th>{% endif %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for post in posts %}
                            <tr>
                                <td>{{ post.id }}</td>
                                <td>{{ post.title }}</td>
                                <td>{{ post.category }}</td>
                                <td>{{ post.created_at }}</td>
                                <td>{{ post.updated_at }}</td>
                                {% if can_edit_content %}
                                    <td class="sol-text-right sol-space-x-sm">
                                        <a href="/admin/posts/edit.php?id={{ post.id }}" class="sol-btn sol-btn--sm">Edit</a>
                                        {% if is_super_admin %}
                                            <form method="post" action="/admin/posts/delete.php" class="inline-form" onsubmit="return confirm('Delete this post?');">
                                                <input type="hidden" name="id" value="{{ post.id }}">
                                                <input type="hidden" name="_token" value="{{ csrf_token }}">
                                                <button type="submit" class="sol-btn sol-btn--sm sol-btn--danger">Delete</button>
                                            </form>
                                        {% endif %}
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>

    {% if is_super_admin %}
        <div class="sol-card sol-mt-lg">
            <div class="sol-card__header">Recent activity</div>
            <div class="sol-card__body">
                {% if audit_logs is empty %}
                    <p class="text-muted">No audit events recorded.</p>
                {% else %}
                    <div class="sol-table-responsive">
                        <table class="sol-table sol-table--compact">
                            <thead>
                            <tr>
                                <th>Time</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Entity</th>
                                <th>IP</th>
                                <th>Metadata</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for log in audit_logs %}
                                <tr>
                                    <td>{{ log.created_at }}</td>
                                    <td>{{ log.username ?? 'system' }}</td>
                                    <td>{{ log.action }}</td>
                                    <td>{{ log.entity_type ? log.entity_type ~ (log.entity_id ? ' #' ~ log.entity_id : '') : '—' }}</td>
                                    <td>{{ log.ip_address ?: '—' }}</td>
                                    <td><code>{{ log.metadata ?: '{}' }}</code></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}
